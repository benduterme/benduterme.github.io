const DATA = {
  global: {
    "email": "benduterme@gmail.com",
    "token": "e999d8b6-b853-494b-a600-a3a4dcc0734e",
  },
  articles: [
    {
      type: "pralibel",
      typeName: "Pralibel",
      prix: {
        "250 g": 9.5,
        "500 g": 19.,
        "1 kg": 38.,
      },
      articles: [
        {id: "pralibel-1", nom: "Assortiment Chocolats noirs", img: "./src/img/Pralibel/logo-pralibel.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "pralibel-2", nom: "Assortiment Chocolats au lait", img: "./src/img/Pralibel/logo-pralibel.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "pralibel-3", nom: "Assortiment Chocolats blancs", img: "./src/img/Pralibel/logo-pralibel.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "pralibel-4", nom: "Assortiment Pralinés noirs", img: "./src/img/Pralibel/logo-pralibel.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "pralibel-5", nom: "Assortiment Pralinés au lait", img: "./src/img/Pralibel/logo-pralibel.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "pralibel-6", nom: "Assortiment Pralinés blancs", img: "./src/img/Pralibel/logo-pralibel.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "pralibel-7", nom: "Assortiment Chocolats noirs - blancs - lait", img: "./src/img/Pralibel/logo-pralibel.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "pralibel-8", nom: "Assortiment Pralinés noirs - blancs - lait", img: "./src/img/Pralibel/logo-pralibel.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "pralibel-9", nom: "Assortiment Pâtes d'amandes", img: "./src/img/Pralibel/logo-pralibel.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
      ]
    },
    {
      type: "ovidias",
      typeName: "Ovidias",
      prix: {
        "250 g": 6.4,
        "500 g": 12.8,
        "1 kg": 25.6,
      },
      articles: [
        {id: "ovidias-2", nom: "Assortiment Chocolats noirs", img: "./src/img/Ovidias/ovidias-logo.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "ovidias-3", nom: "Assortiment Chocolats au lait", img: "./src/img/Ovidias/ovidias-logo.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "ovidias-4", nom: "Assortiment Chocolats blancs", img: "./src/img/Ovidias/ovidias-logo.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "ovidias-5", nom: "Assortiment Pralinés noirs", img: "./src/img/Ovidias/ovidias-logo.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "ovidias-6", nom: "Assortiment Pralinés au lait", img: "./src/img/Ovidias/ovidias-logo.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "ovidias-7", nom: "Assortiment Pralinés blancs", img: "./src/img/Ovidias/ovidias-logo.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "ovidias-8", nom: "Assortiment Chocolats noirs - blancs - lait", img: "./src/img/Ovidias/ovidias-logo.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
        {id: "ovidias-9", nom: "Assortiment Pralinés noirs - blancs - lait", img: "./src/img/Ovidias/ovidias-logo.jpg", choix: [{value: "250 g", count: 0, type: "poids", poids: 0.25}, {value: "500 g", count: 0, type: "poids", poids: 0.5}, {value: "1 kg", count: 0, type: "poids", poids: 1}]},
      ]
    },
    {
      type: "confiseries",
      typeName: "Confiseries et spécialités",
      prix: {

      },
      articles: [
        {id: "confiseries-1", nom: "Orangettes - 180 g", img: "./src/img/Cadeaux/Orangettes.jpg", choix: [{value: 8., count: 0, type: "euros", poids: 0.18}]},
        {id: "confiseries-2", nom: "Cerisettes - 180 g", img: "./src/img/Pralibel/confiseries/cerisette.png", choix: [{value: 9., count: 0, type: "euros", poids: 0.18}]},
        {id: "confiseries-3", nom: "Mendiants - 180 g", img: "./src/img/Cadeaux/Mendiants.jpg", choix: [{value: 8., count: 0, type: "euros", poids: 0.18}]},
        {id: "confiseries-4", nom: "Gianduja - 180 g", img: "./src/img/Cadeaux/Gianduja.png", choix: [{value: 8., count: 0, type: "euros", poids: 0.18}]},
        {id: "confiseries-5", nom: "Liqueurs - 180 g", img: "./src/img/Cadeaux/liqueurs.jpg", choix: [{value: 9., count: 0, type: "euros", poids: 0.18}]},
        {id: "confiseries-6", nom: "Truffes - 250 g", img: "./src/img/Cadeaux/Truffes.jpg", choix: [{value: 8., count: 0, type: "euros", poids: 0.25}]},
        {id: "confiseries-7", nom: "Pâtes de fruits - 180 g", img: "./src/img/Cadeaux/Pâtes de Fruits.jpg", choix: [{value: 8., count: 0, type: "euros", poids: 0.18}]},
        {id: "confiseries-8", nom: "Pralines sans sucre - 250 g", img: "./src/img/Cadeaux/Stevia.jpg", choix: [{value: 11., count: 0, type: "euros", poids: 0.25}]},
        {id: "confiseries-9", nom: "Florentines - ± 10 pcs", img: "./src/img/Cadeaux/florentines.jpg", choix: [{value: 9., count: 0, type: "euros", poids: 0.25}]},
        {id: "confiseries-10", nom: "Palets de chocolat - 17 pcs", img: "./src/img/Cadeaux/palets-chocolat.png", choix: [{value: 8., count: 0, type: "euros", poids: 0.25}]},
        {id: "confiseries-11", nom: "Assortiment - 24 mini tablettes", img: "./src/img/Cadeaux/assortiment-noël.png", choix: [{value: 19.9, count: 0, type: "euros", poids: 0.25}]},
        {id: "confiseries-12", nom: "Nougats - 150 g", img: "./src/img/Cadeaux/nougats.PNG", choix: [{value: 7.9, count: 0, type: "euros", poids: 0.15}]},
      ]
    },
  ]
}


function shop() {

  return {
    articles: DATA["articles"],
    prix: DATA["prix"],
    panier: {},
    total: 0.,
    user: {
      nom: "",
      prenom: "",
      email: "",
      telephone: "",
      date: "",
      recupMarchandise: "Magasin",
      modePaiement: "",
      cgv: "",
      paysLivraison: "Belgique/Lux",
      destinataire: "",
      address: "",
      codePostal: "",
      ville: ""
    },
    errors: [],
    success: [],
    mounted() {
      for (let topArticle of this.articles) {
        for (let article of topArticle.articles) {
          article.prix = topArticle.prix
          for (let choix of article.choix) {
            let nom = `${topArticle.typeName} - ${article.nom}`
            if (choix.type === "poids") {
              nom = `${nom} - ${choix.value}`
            }
            let count = choix.count
            let prix = 0
            let poids = 0
            this.panier[this._getId(article, choix)] = { nom, count, prix, poids, choixRef: choix, articleRef: article }
          }
        }
      }
    },
    resetArticlePanier(id) {
      this.panier[id].count = 0
      this.panier[id].prix = 0
      this.panier[id].poids = 0
      this.panier[id].choixRef.count = 0
    },
    decreaseArticlePanier(id) {
      let article = this.panier[id].articleRef
      let choix = this.panier[id].choixRef
      let poids = this.panier[id]
      this.decremente(article, choix, poids)
    },
    increaseArticlePanier(id) {
      let article = this.panier[id].articleRef
      let choix = this.panier[id].choixRef
      let poids = this.panier[id]
      this.incremente(article, choix, poids)
    },
    setSuccess(success) {
      while (this.success.length) { this.success.pop() }
      for (let s of success) { this.success.push(s) }
    },
    setError(errors) {
      while (this.errors.length) { this.errors.pop() }
      for (let error of errors) { this.errors.push(error) }
    },
    choixStr(choix) {
      if (choix.type == "euros") {
        return choix.value + " €";
      }
      else return choix.value;
    },
    _getId({ id: id }, { type: type, value: value }) {
      return `${id}-${type}-${value}`
    },
    getArticles(type) {
      const topArticle = this.articles.find( el => el.type === type )
      return topArticle.articles
    },
    _getPrix(article, choix) {
      if (choix.type === "poids") {
        return choix.count * article.prix[choix.value]
      }
      else if (choix.type === "euros") {
        return choix.count * choix.value
      }
      else {
        throw "Mauvais type de choix: peut valoir 'poids' ou 'euros'"
      }
    },
    getTotal() {
      return this.getPanier().map(([_, article]) => article.prix).reduce((acc, prix) => acc+prix, 0)
    },
    decremente(article, choix) {
      choix.count--
      let id = this._getId(article, choix)
      this.panier[id].count--
      this.panier[id].prix = this._getPrix(article, choix)
      this.panier[id].poids = choix.poids * this.panier[id].count
    },
    incremente(article, choix) {
      choix.count++
      let id = this._getId(article, choix)
      this.panier[id].count++
      this.panier[id].prix = this._getPrix(article, choix)
      this.panier[id].poids = choix.poids * this.panier[id].count
    },
    getPanier() {
      return Object.entries(this.panier)
      .filter(([_, article]) => article.count > 0)
    },
    getPoidsTotal() {
      return this.getPanier().map(([_, article]) => article.poids).reduce((acc, poids) => acc+poids, 0)
    },
    getShippingPrice() {
      if (this.user.recupMarchandise !== "Livraison") {
        return 0;
      }

      let total = this.getPoidsTotal()
      if (this.user.paysLivraison === "Belgique/Lux") {
        if(total <= 3) {
          return 3.90
        } else if (total <= 7) {
          return 4.40
        } else {
          return 5.50
        }
      }

      if (this.user.paysLivraison === "France") {
        if(total <= 0.5) {
          return 6.
        } else if (total <= 1) {
          return 6.90
        } else if (total <= 3) {
          return 8.20
        } else if (total <= 5) {
          return 9.80
        } else if (total <= 7) {
          return 11.00
        } else if (total <= 10) {
          return 15.60
        } else if (total <= 15) {
          return 19.40
        }
      }

      if (this.user.paysLivraison === "Espagne") {
        if(total <= 0.5) {
          return 9
        } else if (total <= 1) {
          return 9.80
        } else if (total <= 2) {
          return 10.50
        } else if (total <= 3) {
          return 12.80
        } else if (total <= 5) {
          return 15.20
        } else if (total <= 7) {
          return 17.40
        } else if (total <= 10) {
          return 22.80
        } else if (total <= 15) {
          return 27.50
        }
      }
      throw "Manque pays de Livraison"
    },
    getFinalTotal() {
      if (this.user.recupMarchandise === "Livraison") {
        return this.getTotal() + this.getShippingPrice()
      } else {
        return this.getTotal()
      }
    },
    getRandomNumber() {
      return Math.floor(Math.random() * Math.floor(9));
    },
    getRefCom() {
      return `${this.getRandomNumber()}${this.getRandomNumber()}${this.getRandomNumber()}${this.getRandomNumber()}${this.getRandomNumber()}${this.getRandomNumber()}`
    },
    getQteTotal() {
      return this.getPanier().map(([_, article]) => article.count).reduce((acc, count) => acc+count, 0);
    },
    sendEmail() {
      this.errors = []
      this.success = []

      const data = DATA.global
      let hasError = false
      let errors = []
      if ( (!this.user.nom) || (!this.user.prenom) || (!this.user.email) ) {
        errors.push("Il manque des informations personnelles")
      }
      if (this.user.recupMarchandise === "Magasin") {
        if ( (!this.user.date) ) {
          errors.push("Veuillez indiquer une date d'enlèvement souhaitée")
        }
      }
      if ( (!this.user.recupMarchandise) ) {
        errors.push("Veuillez indiquer comment vous souhaitez récupérer votre marchandise")
      }
      if ((this.user.recupMarchandise === "Livraison")) {
        if((!this.user.paysLivraison)) {
          errors.push("Veuillez indiquer le pays de livraison des marchandises");
        }
        if((!this.user.destinataire) || (!this.user.address) || (!this.user.codePostal) || (!this.user.ville)) {
          errors.push("Veuillez compléter les coordonnées de livraison")
        }
      }
      if( (!this.user.modePaiement) ) {
        errors.push("Veuillez indiquer le mode de paiement souhaité");
      }
      if (! this.getPanier().length) {
        errors.push("Votre panier est vide")
      }
      if (errors.length) {
        this.setError(errors)
        return
      }

      let refCom = this.getRefCom();

      let message =
            `Demande de commande:<br>`
          + `-------------------<br><br>`
          + `Pour: ${this.user.nom} ${this.user.prenom} - ${this.user.email}`
      if (this.user.telephone)
        message += ` (${this.user.telephone})<br><br>`
      else {
        message += '<br><br>'
      }

      message += `Référence: ${refCom}<br><br>`

      if(this.user.recupMarchandise === "Magasin") {
        message+= `Date d'enlèvement: ${this.user.date}<br><br>`
      }
      
      message += `<table>`

      message += `<tr><td>Articles</td><td>Quantité</td><td>Prix</td></tr>`
      for (let [id, article] of this.getPanier()) {
        message += `<tr><td>${article.nom}</td><td>${article.count}</td><td>${article.prix.toFixed(2)} €</td></tr>`
      }

      let total = this.getTotal()
      if (this.user.recupMarchandise === "Livraison") {
        total += this.getShippingPrice()
      }

      total = total.toFixed(2)

      if(this.user.recupMarchandise === "Livraison") {
        let shippingPrice = this.getShippingPrice().toFixed(2);
        message += `<tr><td colspan="2">Frais de livraison:</td><td>${shippingPrice} €</td></tr>`
      }

      message += `<tr><td>Total:</td><td>${this.getQteTotal()}</td><td>${total} €</td></tr>`

      message += `</table><br><br>`

      message += `Récupération de la marchandise: ${this.user.recupMarchandise}<br><br>`

      if(this.user.recupMarchandise === "Livraison") {
        message += `Nom et prénom du destinataire: ${this.user.destinataire}<br>`
        message += `Adresse: ${this.user.address}<br>`
        message += `Code postal: ${this.user.codePostal} - Ville: ${this.user.ville}<br><br>`
      }

      message += `Mode de paiement: ${this.user.modePaiement}`

      const toEmail = encodeURIComponent(data.toemail)
      Email.send({
        SecureToken: data.token,
        To: "lagourmandisebouillon@gmail.com",
        From: data.email,
        Subject: "Demande de commande",
        Body: message,
      }).then(mess => {
        if (mess === "OK") {
          this.setSuccess(["Merci pour votre commande. Nous reviendrons vers vous dans les plus brefs délais."])
        }
        else {
          this.setError(["Il y a eu un problème avec l'envoi de votre email."])
        }
      })

      let message2 = 
          `Commande n° ${refCom}<br><br>`
        + `Madame, Monsieur,<br><br>`
        + `Nous avons le plaisir de vous confirmer l'envoi de votre commande.<br>`
        + `Mondial Relay vous informera bientôt par message ou par e-mail de l'arrivée de votre colis.<br>`
        + `Nous espérons que votre commande répondra à toutes vos attentes.<br><br>`
        + `Récaputilatif de votre commande:<br>`
        + `-------------------<br><br>`
        + `Nom: ${this.user.nom} - Prénom: ${this.user.prenom}<br>`
        + `E-mail: ${this.user.email}`

      if (this.user.telephone)
        message2 += ` - ${this.user.telephone}<br><br>`
      else {
        message2 += '<br><br>'
      }

      if(this.user.recupMarchandise === "Magasin") {
        message+= `Date d'enlèvement: ${this.user.date}<br><br>`
      }
      
      message2 += `<table>`

      message2 += `<tr><td>Articles</td><td>Quantité</td><td>Prix</td></tr>`
      for (let [id, article] of this.getPanier()) {
        message2 += `<tr><td>${article.nom}</td><td>${article.count}</td><td>${article.prix.toFixed(2)} €</td></tr>`
      }

      if(this.user.recupMarchandise === "Livraison") {
        let shippingPrice = this.getShippingPrice().toFixed(2);
        message2 += `<tr><td colspan="2">Frais de livraison:</td><td>${shippingPrice} €</td></tr>`
      }

      message2 += `<tr><td colspan="2">Total:</td><td>${total} €</td></tr>`

      message2 += `</table><br><br>`

      message2 += `Récupération de la marchandise: ${this.user.recupMarchandise}<br><br>`

      if(this.user.recupMarchandise === "Livraison") {
        message2 += `Nom et prénom du destinataire: ${this.user.destinataire}<br>`
        message2 += `Adresse: ${this.user.address}<br>`
        message2 += `Code postal: ${this.user.codePostal} - Ville: ${this.user.ville}<br><br>`
      }

      message2 += `Mode de paiement: ${this.user.modePaiement}<br><br>`

      message2 += `<img src="" alt="La Gourmandise Bouillon">`

      if (this.user.recupMarchandise === "Livraison") {
        Email.send({
          SecureToken: data.token,
          To: "lagourmandisebouillon@gmail.com",
          From: data.email,
          Subject: "Votre commande a été expédiée",
          Body: message2,
        })
      }

      let message3 = 
        `Commande n° ${refCom}<br><br>`
        + `Madame, Monsieur,<br><br>`
        + `Merci pour votre commande chez La Gourmandise.<br>`
        + `Nous vous remercions pour votre confiance et mettrons tout en oeuvre pour qu'elle réponde à vos attentes.<br>`
        if (this.user.modePaiement === "Virement") {
          message3 += `Nous vous invitons, dès à présent, à procéder au paiement de la commande pour un envoi dans les plus brefs délais.<br>`
          message3 += `Les coordonnées sont les suivantes:<br><br>`
          message3 += `Nom: La Gourmandise Bouillon<br>`
          message3 += `IBAN: BE45 7326 6015 6789<br>`
          message3 += `BIC: CREGBEBB<br>`
          message3 += `Communication: ${this.user.nom} ${this.user.prenom} ${refCom}<br><br>`
          message3 += `À réception du versement, `
          if (this.user.recupMarchandise === "Livraison") {
            message3 += `nous vous confirmerons l'envoi de votre commande rapidement.<br><br>`
          } else {
            message3 += `nous vous informerons dès qu'elle sera prête pour l'enlèvement.<br><br>`
          }
        } else {
          message3 += `Nous préparerons votre commande avec le plus grand soin pour la date souhaitée et `
          if (this.user.recupMarchandise === "Livraison") {
            message3 += `vous contacterons lorsqu'elle sera envoyée.<br><br>`
          } else {
            message3 += `vous informerons lorsqu'elle sera prête pour l'enlèvement.<br><br>`
          }
        }

        message3 += `Récaputilatif de votre commande:<br>`
        message3 += `-------------------<br><br>`
        message3 += `Nom: ${this.user.nom} - Prénom: ${this.user.prenom}<br>`
        message3 += `E-mail: ${this.user.email}`

      if (this.user.telephone)
        message3 += ` - ${this.user.telephone}<br><br>`
      else {
        message3 += '<br><br>'
      }

      if(this.user.recupMarchandise === "Magasin") {
        message+= `Date d'enlèvement: ${this.user.date}<br><br>`
      } else {
        message+= `<br>`
      }
      
      message3 += `<table>`

      message3 += `<tr><td>Articles</td><td>Quantité</td><td>Prix</td></tr>`
      for (let [id, article] of this.getPanier()) {
        message3 += `<tr><td>${article.nom}</td><td>${article.count}</td><td>${article.prix.toFixed(2)} €</td></tr>`
      }

      if(this.user.recupMarchandise === "Livraison") {
        let shippingPrice = this.getShippingPrice().toFixed(2);
        message3 += `<tr><td colspan="2">Frais de livraison:</td><td>${shippingPrice} €</td></tr>`
      }

      message3 += `<tr><td colspan="2">Total:</td><td>${total} €</td></tr>`

      message3 += `</table><br><br>`

      message3 += `Récupération de la marchandise: ${this.user.recupMarchandise}<br><br>`

      if(this.user.recupMarchandise === "Livraison") {
        message3 += `Nom et prénom du destinataire: ${this.user.destinataire}<br>`
        message3 += `Adresse: ${this.user.address}<br>`
        message3 += `Code postal: ${this.user.codePostal} - Ville: ${this.user.ville}<br><br>`
      }

      message3 += `Mode de paiement: ${this.user.modePaiement}<br><br>`
      
      message3 += `<img src="" alt="La Gourmandise Bouillon">`

      Email.send({
        SecureToken: data.token,
        To: "lagourmandisebouillon@gmail.com",
        From: data.email,
        Subject: "Confirmation de votre commande",
        Body: message3,
      })

      let message4 = 
        `Commande n° ${refCom}<br><br>`
        + `Madame, Monsieur,<br><br>`
        + `Nous avons le plaisir de vous annoncer que votre commande est prête et disponible dans votre magasin.<br><br>`
        + `Nous vous invitons à venir la récupérer durant les heures d'ouverture de celui-ci, à savoir du mardi au dimanche, de 10 h 00 à 12 h 00 et de 13 h 30 à 18 h 00.<br><br>`
        + `Merci pour votre confiance et nous espérons que vous serez entièrement satisfaits par nos chocolats.<br><br>`
        + `<img src="" alt="La Gourmandise Bouillon">`
      
      if(this.user.recupMarchandise === "Magasin") {
        Email.send({
          SecureToken: data.token,
          To: "lagourmandisebouillon@gmail.com",
          From: data.email,
          Subject: "Votre commande est prête",
          Body: message4,
        })
      }
    },
  }
}
